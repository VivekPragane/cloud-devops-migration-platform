# Legacy Azure CI/CD pipeline (archived during AWS migration - Phase 4)

name: DevOps Pipeline

on:
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: electromart-app
  ACR_NAME: ${{ secrets.AZURE_ACR_NAME }}
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/Dockerfile.backend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure ACR
        run: |
          echo ${{ secrets.ACR_PASWORD }} | docker login ${{ secrets.ACR_LOGIN_SERVER }} -u ${{ secrets.ACR_USRNAME }} --password-stdin

      - name: Build Docker Images
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest -f docker/Dockerfile.backend .
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}-frontend:latest -f docker/Dockerfile.frontend .

      - name: Security Scan
        run: bash security/trivy_scan.sh ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name: Push Images to ACR
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}-frontend:latest

      - name: Terraform Apply
        run: |
          cd terraform
          bash init.sh
